{% extends 'base.html.twig' %}

{% block title %}Async Tasks{% endblock %}

{% block body %}
    <h1>Asynchronous Tasks</h1>

    <div>
        <p>Tasks are running in the background using Symfony Messenger.</p>
        <p>To process tasks, run the worker: <code>php bin/console messenger:consume async</code></p>
    </div>

    <div>
        <h3>Generate Payslips (PDF)</h3>
        <p>Create PDF files for all employees of the selected period.</p>
        
        <form action="{{ path('app_async_generate_all_payslips', {'periodId': 0}) }}" method="post" id="payslipForm">
            <div>
                <label for="periodSelect">Select a period:</label>
                <select id="periodSelect" name="periodId" required>
                    <option value="">-- Select a period --</option>
                    {% for period in periods %}
                        <option value="{{ period.id }}">
                            {{ period.startDate|date('Y-m-d') }} - {{ period.endDate|date('Y-m-d') }} ({{ period.status }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn">
                Start PDF Generation
            </button>
        </form>
    </div>

    <div style="margin-top: 30px;">
        <h3>Generate Payroll Report</h3>
        <p>Create a summary statement for the bank or accounting department.</p>
        
        <form action="{{ path('app_async_generate_report', {'periodId': 0}) }}" method="post" id="reportForm">
            <div>
                <label for="reportPeriodSelect">Select a period:</label>
                <select id="reportPeriodSelect" name="periodId" required>
                    <option value="">-- Select a period --</option>
                    {% for period in periods %}
                        <option value="{{ period.id }}">
                            {{ period.startDate|date('Y-m-d') }} - {{ period.endDate|date('Y-m-d') }} ({{ period.status }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn">
                Create Report
            </button>
        </form>
    </div>

    <div style="margin-top: 30px;">
        <h4>Statistics:</h4>
        <p><strong>Total employees:</strong> {{ employee_count }}</p>
        <p><strong>Payment periods:</strong> {{ period_count }}</p>
        <p><strong>Messenger Transport:</strong> Async (Database)</p>
    </div>

    <div style="margin-top: 30px;">
        <a href="{{ path('app_employee_index') }}">Employees</a> |
        <a href="{{ path('app_payroll_period_index') }}">Payroll Periods</a> |
        <a href="{{ path('complex_calc') }}">Calculations</a>
    </div>

    <script>
        document.getElementById('periodSelect').addEventListener('change', function() {
            const form = document.getElementById('payslipForm');
            const periodId = this.value;
            form.action = "{{ path('app_async_generate_all_payslips', {'periodId': 0}) }}".replace('0', periodId);
        });

        document.getElementById('reportPeriodSelect').addEventListener('change', function() {
            const form = document.getElementById('reportForm');
            const periodId = this.value;
            form.action = "{{ path('app_async_generate_report', {'periodId': 0}) }}".replace('0', periodId);
        });
    </script>
{% endblock %}